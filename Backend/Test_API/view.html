<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω s·∫£n ph·∫©m</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        h2 {
            color: #333;
        }

        .form-container {
            margin-bottom: 30px;
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
        }

        .form-container input,
        textarea,
        select {
            display: block;
            margin-bottom: 10px;
            padding: 6px;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

        .form-container button {
            padding: 8px 16px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 6px;
            cursor: pointer;
        }

        .form-container button:hover {
            background-color: #0056b3;
        }

        .product-list {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .product-card {
            border: 1px solid #ccc;
            border-radius: 10px;
            padding: 15px;
            width: 250px;
            background: #fff;
            position: relative;
        }

        .product-card img {
            width: 100%;
            height: 180px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .actions button {
            flex: 1;
            padding: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .edit-btn {
            background-color: #ffc107;
            color: black;
        }

        .delete-btn {
            background-color: #dc3545;
            color: white;
        }
    </style>
</head>

<body>
    <h2>üì¶ Qu·∫£n l√Ω s·∫£n ph·∫©m</h2>

    <div class="form-container">
        <h3 id="form-title">‚ûï Th√™m s·∫£n ph·∫©m m·ªõi</h3>
        <input type="hidden" id="productId">
        <input id="productName" placeholder="T√™n s·∫£n ph·∫©m">
        <input id="productCode" placeholder="M√£ s·∫£n ph·∫©m">
        <input id="category" placeholder="Danh m·ª•c">
        <input id="unit" placeholder="ƒê∆°n v·ªã t√≠nh">
        <input id="quantity" type="number" placeholder="S·ªë l∆∞·ª£ng">
        <input id="importPrice" type="number" placeholder="Gi√° nh·∫≠p">
        <input id="salePrice" type="number" placeholder="Gi√° b√°n">
        <input id="promotion" placeholder="Khuy·∫øn m√£i">
        
        <!-- Dropdown nh√† cung c·∫•p -->
        <select id="supplierId">
            <option value="">-- Ch·ªçn nh√† cung c·∫•p --</option>
        </select>

        <input type="file" id="imageInput">
        <button onclick="addProduct()">üíæ L∆∞u s·∫£n ph·∫©m</button>
    </div>

    <div class="product-list" id="productList">
        <p>üîÑ ƒêang t·∫£i d·ªØ li·ªáu...</p>
    </div>

    <script>
        const API_BASE = "https://localhost:44397/api";
        let token = "";

        async function login() {
            const res = await fetch(`${API_BASE}/Auth/login`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username: "admin", password: "123456" })
            });
            const data = await res.json();
            token = data.token;
        }

        async function fetchSuppliers() {
            const res = await fetch(`${API_BASE}/Suppliers`, {
                headers: { "Authorization": `Bearer ${token}` }
            });
            const suppliers = await res.json();

            const select = document.getElementById("supplierId");
            select.innerHTML = '<option value="">-- Ch·ªçn nh√† cung c·∫•p --</option>';

            suppliers.forEach(supplier => {
                const option = document.createElement("option");
                option.value = supplier.id;
                option.textContent = supplier.name || supplier.companyName || "Nh√† cung c·∫•p";
                select.appendChild(option);
            });
        }

        async function fetchProducts() {
            const res = await fetch(`${API_BASE}/Product`, {
                headers: { "Authorization": `Bearer ${token}` }
            });
            const products = await res.json();
            const list = document.getElementById("productList");
            list.innerHTML = "";

            if (!Array.isArray(products) || products.length === 0) {
                list.innerHTML = "<p>Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o.</p>";
                return;
            }
            console.log(products);

            products.forEach(product => {
                const card = document.createElement("div");
                card.className = "product-card";
                card.innerHTML = `
                    <img src="data:image/jpeg;base64,${product.imageData || ""}" alt="${product.productName}">
                    <h3>${product.productName}</h3>
                    <p><strong>Gi√°:</strong> ${Number(product.salePrice).toLocaleString()} VND</p>
                    <p><strong>S·ªë l∆∞·ª£ng:</strong> ${product.quantity}</p>
                    <p><strong>M√¥ t·∫£:</strong> ${product.description || "Kh√¥ng c√≥ m√¥ t·∫£"}</p>
                    <div class="actions">
                        <button class="edit-btn" onclick='editProduct(${JSON.stringify(product)})'>S·ª≠a</button>
                        <button class="delete-btn" onclick='deleteProduct(${product.id})'>Xo√°</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function resetForm() {
            document.getElementById("form-title").textContent = "‚ûï Th√™m s·∫£n ph·∫©m m·ªõi";
            document.getElementById("productId").value = "";
            document.getElementById("productName").value = "";
            document.getElementById("productCode").value = "";
            document.getElementById("category").value = "";
            document.getElementById("unit").value = "";
            document.getElementById("quantity").value = "";
            document.getElementById("importPrice").value = "";
            document.getElementById("salePrice").value = "";
            document.getElementById("promotion").value = "";
            document.getElementById("imageInput").value = "";
            document.getElementById("supplierId").value = "";
            imageBase64String = null;
        }

        let imageBase64String = null;

        document.getElementById("imageInput").addEventListener("change", function () {
            const file = this.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                imageBase64String = e.target.result.split(",")[1];
            };
            reader.readAsDataURL(file);
        });

        async function addProduct() {
            const productId = document.getElementById("productId").value;
            const supplierId = document.getElementById("supplierId").value;

            if (!supplierId) {
                alert("Vui l√≤ng ch·ªçn nh√† cung c·∫•p.");
                return;
            }

            const product = {
                productName: document.getElementById("productName").value,
                productCode: document.getElementById("productCode").value,
                category: document.getElementById("category").value,
                unit: document.getElementById("unit").value,
                quantity: parseInt(document.getElementById("quantity").value),
                importPrice: parseFloat(document.getElementById("importPrice").value),
                salePrice: parseFloat(document.getElementById("salePrice").value),
                promotion: document.getElementById("promotion").value,
                imageBase64: imageBase64String || null,
                supplierId: parseInt(supplierId)
            };

            const isEdit = productId !== "";

            try {
                const response = await fetch(`${API_BASE}/Product${isEdit ? "/" + productId : ""}`, {
                    method: isEdit ? "PUT" : "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    },
                    body: JSON.stringify(product)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status} - ${response.statusText}\n${errorText}`);
                }

                alert(isEdit ? "‚úÖ C·∫≠p nh·∫≠t s·∫£n ph·∫©m th√†nh c√¥ng!" : "‚úÖ Th√™m s·∫£n ph·∫©m th√†nh c√¥ng!");
                resetForm();
                fetchProducts();
            } catch (error) {
                console.error("‚ùå L·ªói khi l∆∞u s·∫£n ph·∫©m:", error);
                alert("L·ªói khi l∆∞u s·∫£n ph·∫©m: " + error.message);
            }
        }

        function editProduct(product) {
            document.getElementById("form-title").textContent = "‚úèÔ∏è Ch·ªânh s·ª≠a s·∫£n ph·∫©m";
            document.getElementById("productId").value = product.id;
            document.getElementById("productName").value = product.productName;
            document.getElementById("productCode").value = product.productCode;
            document.getElementById("category").value = product.category;
            document.getElementById("unit").value = product.unit;
            document.getElementById("quantity").value = product.quantity;
            document.getElementById("importPrice").value = product.importPrice;
            document.getElementById("salePrice").value = product.salePrice;
            document.getElementById("promotion").value = product.promotion;
            document.getElementById("supplierId").value = product.supplierId || "";
            imageBase64String = null; // reset ·∫£nh
            window.scrollTo(0, 0);
        }

        async function deleteProduct(id) {
            if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° s·∫£n ph·∫©m n√†y?")) {
                const res = await fetch(`${API_BASE}/Product/${id}`, {
                    method: "DELETE",
                    headers: { "Authorization": `Bearer ${token}` }
                });
                if (res.ok) {
                    fetchProducts();
                } else {
                    alert("‚ùå Xo√° th·∫•t b·∫°i.");
                }
            }
        }

        // Load d·ªØ li·ªáu khi m·ªü trang
        (async () => {
            await login();
            await fetchSuppliers();
            await fetchProducts();
        })();
    </script>
</body>

</html>
